<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„å¿ƒæƒ…å°ç«™</title>
    <script src="//code.bdstatic.com/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
    
    <style>
        /* ç®€å•æ¸…çˆ½çš„æ‰‹æœºç«¯é£æ ¼ */
        body { font-family: -apple-system, sans-serif; background-color: #f7f8fa; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 600px; margin: 0 auto; }
        
        h2 { text-align: center; color: #333; margin-bottom: 20px; font-weight: 600; }

        /* è¾“å…¥æ¡†åŒºåŸŸ */
        .input-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        input, textarea { width: 100%; border: 1px solid #ebedf0; background: #f7f8fa; border-radius: 8px; padding: 12px; font-size: 14px; box-sizing: border-box; margin-bottom: 12px; outline: none; transition: all 0.3s; }
        input:focus, textarea:focus { background: white; border-color: #007aff; }
        
        button { width: 100%; background: #007aff; color: white; border: none; padding: 12px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
        button:active { opacity: 0.8; transform: scale(0.98); }
        button:disabled { background: #ccc; cursor: not-allowed; }

        /* ç•™è¨€åˆ—è¡¨ */
        #list { list-style: none; padding: 0; }
        .msg-card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.03); animation: fadeIn 0.5s; position: relative; }
        .msg-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; }
        .user-name { font-weight: bold; color: #333; font-size: 15px; }
        .time { font-size: 12px; color: #999; }
        .content { font-size: 15px; line-height: 1.6; color: #555; white-space: pre-wrap; }
        
        /* åˆ é™¤æŒ‰é’® */
        .del-btn { color: #ff4d4f; font-size: 12px; cursor: pointer; margin-left: 10px; padding: 2px 6px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loading { text-align: center; color: #999; font-size: 13px; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸƒ æ ‘æ´ç•™è¨€æ¿</h2>
    
    <div class="input-card">
        <input type="text" id="name" placeholder="ä½ çš„æ˜µç§° (æ¯”å¦‚: åŒ¿å)">
        <textarea id="content" rows="3" placeholder="æ­¤åˆ»åœ¨æƒ³ä»€ä¹ˆï¼Ÿå†™ä¸‹æ¥å§..."></textarea>
        <button id="submitBtn" onclick="sendMsg()">å‘å¸ƒç•™è¨€</button>
    </div>

    <div id="list">
        </div>
    <div id="status" class="loading">æ­£åœ¨è¿æ¥äº‘ç«¯...</div>
</div>

<script>
    // ==========================================
    // ğŸ”´ å…³é”®æ­¥éª¤ï¼šè¯·æ›¿æ¢ä¸‹é¢åŒå¼•å·é‡Œçš„å†…å®¹
    // ==========================================
    const APP_ID = "43gX061n6bbqH0aI5V2XhMUM-MdYXbMMI"; 
    const APP_KEY = "UV6j2L5vq8iUi9u0J4kfbeoN";
    const SERVER_URL = "https://your-api.com"; // å¦‚æœæ˜¯LeanCloudå›½é™…ç‰ˆå¯ä¸å¡«ï¼Œå›½å†…ç‰ˆéœ€å¡«è‡ªå®šä¹‰åŸŸå
    
    // --- ä¸‹é¢æ˜¯é€»è¾‘ä»£ç ï¼Œä¸éœ€è¦æ”¹åŠ¨ ---

    // 1. åˆå§‹åŒ– LeanCloud
    if (APP_ID === "ä½ çš„AppID") {
        document.getElementById('status').innerText = "âš ï¸ è¯·å…ˆåœ¨ä»£ç ä¸­å¡«å…¥ AppID å’Œ AppKey";
        alert("åˆ«å¿˜äº†å¡«å…¥ LeanCloud çš„ ID å’Œ Key å“¦ï¼å¦åˆ™æ— æ³•å­˜å‚¨æ•°æ®ã€‚");
    } else {
        // å°è¯•åˆå§‹åŒ– (å…¼å®¹å¤„ç†)
        try {
           if(SERVER_URL && SERVER_URL !== "https://your-api.com") {
               AV.init({ appId: APP_ID, appKey: APP_KEY, serverURL: SERVER_URL });
           } else {
               AV.init({ appId: APP_ID, appKey: APP_KEY });
           }
           document.getElementById('status').innerText = "";
           loadMsg(); // åŠ è½½ç•™è¨€
        } catch(e) {
            console.error(e);
            document.getElementById('status').innerText = "è¿æ¥é…ç½®æœ‰è¯¯ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°";
        }
    }

    // 2. å‘é€ç•™è¨€
    async function sendMsg() {
        const nameInput = document.getElementById('name');
        const contentInput = document.getElementById('content');
        const btn = document.getElementById('submitBtn');

        const name = nameInput.value.trim();
        const content = contentInput.value.trim();

        if (!name || !content) {
            alert("æ˜µç§°å’Œå†…å®¹éƒ½è¦å†™å“¦ï¼");
            return;
        }

        // æŒ‰é’®å˜ç°ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
        btn.disabled = true;
        btn.innerText = "å‘é€ä¸­...";

        try {
            // åˆ›å»ºä¸€æ¡æ–°æ•°æ®
            const Message = AV.Object.extend('Message');
            const msg = new Message();
            msg.set('name', name);
            msg.set('content', content);
            
            await msg.save(); // ä¿å­˜åˆ°äº‘ç«¯

            // æˆåŠŸåæ¸…ç©ºè¾“å…¥æ¡†å¹¶åˆ·æ–°
            contentInput.value = '';
            loadMsg(); 
        } catch (error) {
            alert("å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é…ç½®");
            console.error(error);
        }
        
        btn.disabled = false;
        btn.innerText = "å‘å¸ƒç•™è¨€";
    }

    // 3. æ‹‰å–ç•™è¨€åˆ—è¡¨
    async function loadMsg() {
        const query = new AV.Query('Message');
        query.descending('createdAt'); // æŒ‰æ—¶é—´å€’åºï¼ˆæœ€æ–°çš„åœ¨ä¸Šé¢ï¼‰
        query.limit(50); // æœ€å¤šæ˜¾ç¤º50æ¡

        try {
            const results = await query.find();
            const list = document.getElementById('list');
            list.innerHTML = ''; // æ¸…ç©ºç°æœ‰åˆ—è¡¨

            if (results.length === 0) {
                document.getElementById('status').innerText = "è¿˜æ²¡æœ‰ç•™è¨€ï¼Œæ¥æŠ¢æ²™å‘å§~";
            } else {
                document.getElementById('status').innerText = "";
            }

            results.forEach(msg => {
                const data = msg.attributes;
                const time = msg.createdAt.toLocaleString(); // è‡ªåŠ¨è½¬æ¢æ—¶é—´æ ¼å¼
                
                const div = document.createElement('div');
                div.className = 'msg-card';
                div.innerHTML = `
                    <div class="msg-header">
                        <div>
                            <span class="user-name">${escapeHtml(data.name)}</span>
                            <span class="time">${time}</span>
                        </div>
                        <span class="del-btn" onclick="delMsg('${msg.id}')">åˆ é™¤</span>
                    </div>
                    <div class="content">${escapeHtml(data.content)}</div>
                `;
                list.appendChild(div);
            });
        } catch (error) {
            console.error(error);
            document.getElementById('status').innerText = "åŠ è½½å¤±è´¥";
        }
    }

    // 4. åˆ é™¤ç•™è¨€
    async function delMsg(id) {
        if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡å—ï¼Ÿ")) return;
        
        const msg = AV.Object.createWithoutData('Message', id);
        try {
            await msg.destroy();
            loadMsg(); // åˆ·æ–°
        } catch (error) {
            alert("åˆ é™¤å¤±è´¥");
        }
    }

    // å®‰å…¨è¿‡æ»¤ï¼ˆé˜²æ­¢XSSæ”»å‡»ï¼‰
    function escapeHtml(text) {
        if (!text) return text;
        return text.replace(/&/g, "&amp;")
                   .replace(/</g, "&lt;")
                   .replace(/>/g, "&gt;")
                   .replace(/"/g, "&quot;")
                   .replace(/'/g, "&#039;");
    }
</script>
</body>
</html>
